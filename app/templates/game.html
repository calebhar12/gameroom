<html>
    <head>
        <title>Gameroom {{ room }}</title>
        <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
        <script type="text/javascript" charset="utf-8">
            var socket;
            var playersHand = new Array();
            var playingHand = new Array();

            var name = '{{ name }}';
            $(document).ready(function(){
                socket = io.connect('http://' + document.domain + ':' + location.port + '/game');
                socket.on('connect', function() {
                    socket.emit('joined', {});
                });
                socket.on('status', function(data) {
                    $('#game').val($('#game').val() + '<' + data.msg + '>\n');
                    $('#game').scrollTop($('#game')[0].scrollHeight);
                });
                socket.on('start_game', function() {
                    var x = document.getElementById("startgame");
                    x.style.visibility = "hidden";
                });
                socket.on('deal', function(data) {
                    var json = JSON.parse(data);
                    playersHand = json[name];
                    console.log(playersHand);

                    for(var i = 0; i < playersHand.length; i++){
                        var text = document.createElement("a");

                        text.setAttribute("href", "#");
                        var id = convert_to_value(playersHand[i][0]) + convert_to_suit(playersHand[i][1]);
                        var funcname = "add_card(\"" + id + "\")";
                        text.setAttribute("onclick", funcname);
                        text.setAttribute("id", id);
                        text.innerHTML = convert_to_value(playersHand[i][0]) + " of " + convert_to_suit(playersHand[i][1]) + "<br />"; //added the break in here, made removing cards easier
                        document.getElementById("hand").appendChild(text);
                    }
                    
                    //initialize the "recently played" header
                    var upcardslist = document.getElementById("upcards")
                    upcardslist.innerHTML = "Recently played cards:<br/>"
                    console.log(upcardslist.childElementCount);
                })
                //handle the upcard being changed and render the most recently played cards
                socket.on('change_upcard', function(data) {
                    //clear out old upcards
                    console.log("hi")
                    var oldUpcards = document.getElementById("upcards")

                    for (var i = oldUpcards.childElementCount; i > 0; --i) {
                        oldUpcards.removeChild(oldUpcards.childNodes[i])
                    }
                    
                    console.log("new data")
                    console.log(data)
                    //add new upcards
                    var updatedCards = data['upcards']
                    for(var i = 0; i < updatedCards.length; i++){
                        var text = document.createElement("p");
                        text.setAttribute("id", updatedCards[i]);
                        var innerText = "";
                        if (updatedCards[i].length > 2){
                            innerText = updatedCards[i].substring(0, 2) + " of " + updatedCards[i].substring(2, 3);
                        } else 
                        {
                            innerText = updatedCards[i].substring(0, 1) + " of " + updatedCards[i].substring(1, 2);
                        }
                        text.innerHTML = innerText;
                        oldUpcards.appendChild(text);
                    }
                });

            });
            function leave_room() {
                socket.emit('left', {}, function() {
                    socket.disconnect();

                    // go back to the login page
                    window.location.href = "{{ url_for('main.index') }}";
                });
            }
            function start_game() {
                socket.emit('startgame');

            }

            function add_card(id){
                if(playingHand.length < 5){
                    var card = document.getElementById(id);
                    var text = card.innerHTML;
                    card.innerHTML = "Selected: " + text;
                    var funcname = "remove_card(\"" + id + "\")";
                    card.setAttribute("onclick", funcname);
                    playingHand.push(id);
                    console.log(playingHand);

                    //added a "play selected card(s)" button, added when one card is selected
                    if (playingHand.length == 1){ 
                        var doctext = document.createElement("a");
                        doctext.setAttribute("href", "#");
                        var id_button = "play_card";
                        var funcname_button = "play_cards()";
                        doctext.setAttribute("onclick", funcname_button);
                        doctext.setAttribute("id", id_button);
                        doctext.innerHTML = "play selected card(s)";
                        document.getElementById("playbutton").appendChild(doctext);
                    }
                }
            }

            function remove_card(id){
                var card = document.getElementById(id);
                var text = card.innerHTML;
                card.innerHTML = text.slice(10);
                var funcname = "add_card(\"" + id + "\")";
                card.setAttribute("onclick", funcname);
                var index = playingHand.indexOf(id);
                playingHand.splice(index, 1);
                console.log(playingHand);

                //this will remove play cards button when no more cards are selected
                check_button()
            }

            function check_button() {
                //remove play cards button when no more cards are selected
                if (playingHand.length == 0){
                    var play_button = document.getElementById("playbutton")
                    play_button.removeChild(play_button.childNodes[0]); //this might be a dumb way to do this lol, can perhaps remove by id directly
                }
            }

            function play_cards(){

                // TODO: change validHand to be the hand validation function
                var validHand = new Boolean(true);
                if (validHand){
                    for(var i = 0; i < playingHand.length; ++i){
                        var card = document.getElementById(playingHand[i]);
                        card.remove()
                    }
                    socket.emit('changeupcard', {upcards: playingHand});
                    playingHand = [];
                }

                //need to check the button because it should be removed at this point
                check_button()
            }

            function convert_to_suit(suitNumber){
                if(suitNumber == 1){
                    return "D";
                }
                if(suitNumber == 2){
                    return "C";
                }
                if(suitNumber == 3){
                    return "H";
                }
                if(suitNumber == 4){
                    return "S";
                }
            }

            function convert_to_value(valueNumber){
                if(valueNumber == 15){
                    return "2";
                }
                if(valueNumber == 14){
                    return "A";
                }
                if(valueNumber == 13){
                    return "K";
                }
                if(valueNumber == 12){
                    return "Q";
                }
                if(valueNumber == 11){
                    return "J";
                }
                return valueNumber.toString();
            }
            
        </script>
    </head>
    <body>
        <h1>Game Room: {{ room }}</h1>
        <textarea id="game" cols="80" rows="5"></textarea><br><br>
        <a href="#" onclick="leave_room();">Leave this room</a>

        <a id = "startgame" href="#" onclick="start_game();">Begin game</a>

        <br>
        <br>

        <div id = "hand"></div>
        
        <br>
        <br>

        <div id = "playbutton"></div>

        <br>
        <br>
        <br>
        <br>

        <div id = "upcards"></div>
        
    </body>
</html>
